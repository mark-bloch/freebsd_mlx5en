From: Saeed Mahameed <saeedm@mellanox.com>
Subject: [PATCH] BACKPORT: mlx4_vnic for SLES11SP1

Change-Id: I0832f9a7e84a0342018d1d0a27a909b5a8f355a1
Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
---
 drivers/net/ethernet/mellanox/mlx4_vnic/vnic.h |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/mellanox/mlx4_vnic/vnic.h b/drivers/net/ethernet/mellanox/mlx4_vnic/vnic.h
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/net/ethernet/mellanox/mlx4_vnic/vnic.h
+++ b/drivers/net/ethernet/mellanox/mlx4_vnic/vnic.h
@@ -303,6 +303,7 @@ extern struct ib_sa_client vnic_sa_client;
 #ifndef _BP_NETDEV_NO_TMQ /* >= 2.6.27 */
 #define VNIC_TXQ_GET_HASH(_skb, _max)	(skb_get_queue_mapping(_skb))
 #define VNIC_TXQ_ALLOC_NETDEV(sz, nm, sp, qm) alloc_netdev_mq(sz, nm, sp, qm)
+#if !defined (CONFIG_COMPAT_DISABLE_REAL_NUM_TXQ)
 #define VNIC_TXQ_SET_ACTIVE(login, num) \
             do { \
                 rtnl_lock(); \
@@ -310,6 +311,13 @@ extern struct ib_sa_client vnic_sa_client;
                 rtnl_unlock(); \
                 login->real_tx_rings_num = login->ndo_tx_rings_num = num; \
             } while (0)
+#else
+#define VNIC_TXQ_SET_ACTIVE(login, num) \
+            do { \
+                login->dev->real_num_tx_queues = num; \
+                login->real_tx_rings_num = login->ndo_tx_rings_num = num; \
+            } while (0)
+#endif
 #define VNIC_TXQ_GET_ACTIVE(login)	(login->real_tx_rings_num)
 #define VNIC_TXQ_GET(tx_res)		netdev_get_tx_queue(tx_res->login->dev, tx_res->index)
 #define VNIC_TXQ_STOP(tx_res) 		netif_tx_stop_queue(VNIC_TXQ_GET(tx_res))
