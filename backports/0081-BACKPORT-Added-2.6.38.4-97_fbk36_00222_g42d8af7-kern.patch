From: Alaa Hleihel <alaa@mellanox.com>
Subject: [PATCH] BACKPORT: Added 2.6.38.4-97_fbk36_00222_g42d8af7 kernel support.

Change-Id: I4208cb849b314b61093da2faec243a64ae0bb0d5
Signed-off-by: Alaa Hleihel <alaa@mellanox.com>
---
 drivers/infiniband/core/addr.c      |   17 +++++++++++++++++
 drivers/net/eipoib/eth_ipoib_main.c |    4 ++--
 2 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/drivers/infiniband/core/addr.c b/drivers/infiniband/core/addr.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/core/addr.c
+++ b/drivers/infiniband/core/addr.c
@@ -264,7 +264,11 @@ static int addr4_resolve(struct sockaddr_in *src_in,
 #else
 	src_in->sin_addr.s_addr = rt->rt_src;
 
+#if defined(CONFIG_IS_RTABLE_IDEV)
 	if (rt->idev->dev->flags & IFF_LOOPBACK) {
+#else
+	if (rt->dst.dev->flags & IFF_LOOPBACK) {
+#endif
 #endif
 		ret = rdma_translate_ip((struct sockaddr *)dst_in, addr, NULL);
 		if (!ret)
@@ -285,14 +289,27 @@ static int addr4_resolve(struct sockaddr_in *src_in,
 	ret = dst_fetch_ha(&rt->dst, addr);
 #endif
 #else
+#if defined(CONFIG_IS_RTABLE_IDEV)
 	if (rt->idev->dev->flags & IFF_NOARP) {
 		ret = rdma_copy_addr(addr, rt->idev->dev, NULL);
+#else
+	if (rt->dst.dev->flags & IFF_NOARP) {
+		ret = rdma_copy_addr(addr, rt->dst.dev, NULL);
+#endif
 		goto put;
 	}
 
+#if defined(CONFIG_IS_RTABLE_IDEV)
 	neigh = neigh_lookup(&arp_tbl, &rt->rt_gateway, rt->idev->dev);
+#else
+	neigh = neigh_lookup(&arp_tbl, &rt->rt_gateway, rt->dst.dev);
+#endif
 	if (!neigh || !(neigh->nud_state & NUD_VALID)) {
+#if defined(CONFIG_IS_RTABLE_IDEV)
 		neigh_event_send(rt->u.dst.neighbour, NULL);
+#else
+		neigh_event_send(rt->dst.neighbour, NULL);
+#endif
 		ret = -ENODATA;
 		if (neigh)
 			goto release;
diff --git a/drivers/net/eipoib/eth_ipoib_main.c b/drivers/net/eipoib/eth_ipoib_main.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/net/eipoib/eth_ipoib_main.c
+++ b/drivers/net/eipoib/eth_ipoib_main.c
@@ -57,7 +57,7 @@
 #define PARENT_MAC_MASK 0xe7
 
 /* forward declaration */
-#if (LINUX_VERSION_CODE < KERNEL_VERSION(2,6,36))
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(2,6,36)) || !defined(CONFIG_IS_RX_HANDLER_RESULT)
 typedef int rx_handler_result_t;
 #define RX_HANDLER_CONSUMED 0
 extern int (*eth_ipoib_handle_frame_hook)(struct sk_buff **skb);
@@ -2451,7 +2451,7 @@ static const struct net_device_ops parent_netdev_ops = {
 	.ndo_get_stats = parent_get_stats,
 #endif
 
-#if (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,35))
+#if (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,35)) && defined(CONFIG_IS_NDO_ADD_SLAVE)
 	.ndo_add_slave = parent_enslave,
 	.ndo_del_slave = parent_release_slave,
 #endif
