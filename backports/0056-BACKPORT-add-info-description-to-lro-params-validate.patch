From: Tal Alon <talal@mellanox.com>
Subject: [PATCH] BACKPORT: add info description to lro params, validates params

issue:165150

issue:191112

Signed-off-by: Tal Alon <talal@mellanox.com>
---
 drivers/infiniband/ulp/ipoib/ipoib_main.c |   13 ++++++++-----
 1 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/drivers/infiniband/ulp/ipoib/ipoib_main.c b/drivers/infiniband/ulp/ipoib/ipoib_main.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/ulp/ipoib/ipoib_main.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_main.c
@@ -65,12 +65,12 @@ MODULE_PARM_DESC(recv_queue_size, "Number of descriptors in receive queue (defau
 #ifdef CONFIG_COMPAT_USE_LRO
 static int lro = 1;
 module_param_named(lro, lro, int, 0444);
-MODULE_PARM_DESC(lro,  "Enable LRO (Large Receive Offload)");
+MODULE_PARM_DESC(lro,  "Enable LRO (Large Receive Offload) (default = 1) (0-1)");
 
 static int lro_max_aggr = IPOIB_LRO_MAX_AGGR;
 module_param_named(lro_max_aggr, lro_max_aggr, int, 0444);
-MODULE_PARM_DESC(lro_max_aggr, "LRO: Max packets to be aggregated "
-                               "(default = 64)");
+MODULE_PARM_DESC(lro_max_aggr, "LRO: Max packets to be aggregated must be power of 2"
+                               "(default = 64) (2-64)");
 #endif
 
 #ifdef CONFIG_INFINIBAND_IPOIB_DEBUG
@@ -2828,8 +2828,11 @@ static int __init ipoib_init_module(void)
 #endif
 
 #ifdef CONFIG_COMPAT_USE_LRO
-	lro = !!lro;
-	if (lro_max_aggr < 0 || lro_max_aggr > INT_MAX)
+	if (lro < 0 || lro > 1)
+		lro = 1;
+
+	if (lro_max_aggr < 0 || lro_max_aggr > IPOIB_LRO_MAX_AGGR ||
+	    (lro_max_aggr & (lro_max_aggr - 1)) != 0)
 		lro_max_aggr = IPOIB_LRO_MAX_AGGR;
 #endif
 
