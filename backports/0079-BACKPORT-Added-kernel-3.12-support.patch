From: Vladimir Sokolovsky <vlad@mellanox.com>
Subject: [PATCH] BACKPORT: Added kernel 3.12 support

Change-Id: If6606cd826849835615ef71a7e776d5cef6e8838
Signed-off-by: Vladimir Sokolovsky <vlad@mellanox.com>
---
 net/sunrpc/xprtrdma/svc_rdma_recvfrom.c |   13 +++++++++++++
 net/sunrpc/xprtrdma/svc_rdma_sendto.c   |    8 ++++++++
 2 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/net/sunrpc/xprtrdma/svc_rdma_recvfrom.c b/net/sunrpc/xprtrdma/svc_rdma_recvfrom.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/net/sunrpc/xprtrdma/svc_rdma_recvfrom.c
+++ b/net/sunrpc/xprtrdma/svc_rdma_recvfrom.c
@@ -520,12 +520,21 @@ next_sge:
 	for (ch_no = 0; &rqstp->rq_pages[ch_no] < rqstp->rq_respages; ch_no++)
 		rqstp->rq_pages[ch_no] = NULL;
 
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 12, 0))
 	/*
 	 * Detach res pages. svc_release must see a resused count of
 	 * zero or it will attempt to put them.
 	 */
 	while (rqstp->rq_resused)
 		rqstp->rq_respages[--rqstp->rq_resused] = NULL;
+#else
+	/*
+	 * Detach res pages. If svc_release sees any it will attempt to
+	 * put them.
+	 */
+	while (rqstp->rq_next_page != rqstp->rq_respages)
+		*(--rqstp->rq_next_page) = NULL;
+#endif
 
 	return err;
 }
@@ -550,7 +559,11 @@ static int rdma_read_complete(struct svc_rqst *rqstp,
 
 	/* rq_respages starts after the last arg page */
 	rqstp->rq_respages = &rqstp->rq_arg.pages[page_no];
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 12, 0))
 	rqstp->rq_resused = 0;
+#else
+	rqstp->rq_next_page = &rqstp->rq_arg.pages[page_no];
+#endif
 
 	/* Rebuild rq_arg head and tail. */
 	rqstp->rq_arg.head[0] = head->arg.head[0];
diff --git a/net/sunrpc/xprtrdma/svc_rdma_sendto.c b/net/sunrpc/xprtrdma/svc_rdma_sendto.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/net/sunrpc/xprtrdma/svc_rdma_sendto.c
+++ b/net/sunrpc/xprtrdma/svc_rdma_sendto.c
@@ -548,6 +548,9 @@ static int send_reply(struct svcxprt_rdma *rdma,
 	int sge_no;
 	int sge_bytes;
 	int page_no;
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 12, 0))
+	int pages;
+#endif
 	int ret;
 
 	/* Post a recv buffer to handle another request. */
@@ -611,7 +614,12 @@ static int send_reply(struct svcxprt_rdma *rdma,
 	 * respages array. They are our pages until the I/O
 	 * completes.
 	 */
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 12, 0))
+	pages = rqstp->rq_next_page - rqstp->rq_respages;
+	for (page_no = 0; page_no < pages; page_no++) {
+#else
 	for (page_no = 0; page_no < rqstp->rq_resused; page_no++) {
+#endif
 		ctxt->pages[page_no+1] = rqstp->rq_respages[page_no];
 		ctxt->count++;
 		rqstp->rq_respages[page_no] = NULL;
